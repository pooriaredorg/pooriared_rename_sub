name: Generate Subscriptions

on:
  workflow_dispatch:
    inputs:
      base_name_suffix:
        description: 'Ù†Ø§Ù…ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù†Ø§Ù… Ø³Ø§Ø¨â€ŒÙ‡Ø§ Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹ ALI)'
        required: true
        default: 'suffix'
        type: string
      config_index: 
        description: 'Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ù†ÙÛŒÚ¯ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ù‡ Ø³Ø§Ø¨ ØªØ¨Ø¯ÛŒÙ„ Ø´ÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹ 1 Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯ Ø§ÙˆÙ„)'
        required: true
        default: '1'
        type: string 

# ğŸŒŸ Ù…Ù‡Ù…: Ø§Ø¹Ø·Ø§ÛŒ Ù…Ø¬ÙˆØ² Ù†ÙˆØ´ØªÙ† Ø¨Ø±Ø§ÛŒ Commit Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„
permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Run Bash Script to Generate and Modify Config
      id: generate_config
      shell: bash # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Øª Ø¯Ø± Ù…Ø­ÛŒØ· Bash
      run: |
        # Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ
        CUSTOM_SUFFIX="${{ github.event.inputs.base_name_suffix }}"
        CONFIG_INDEX="${{ github.event.inputs.config_index }}"
        CONFIG_URL="https://raw.githubusercontent.com/pooriaredorg/pooriaredorg/refs/heads/main/configs/proxy_configs.txt"
        BASE_FILE_NAME="POORIARED"

        # 1. Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù‡Ù…Ù‡ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§
        ALL_CONFIGS=$(curl -s "$CONFIG_URL")
        
        # 2. Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§
        CONFIG_COUNT=$(echo "$ALL_CONFIGS" | wc -l)
        
        # 3. Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± ÙˆØ±ÙˆØ¯ÛŒ
        if ! [[ "$CONFIG_INDEX" =~ ^[0-9]+$ ]] || [ "$CONFIG_INDEX" -le 0 ] || [ "$CONFIG_INDEX" -gt "$CONFIG_COUNT" ]; then
            echo "::error::âŒ Invalid CONFIG_INDEX: $CONFIG_INDEX. Must be between 1 and $CONFIG_COUNT."
            exit 1
        fi

        # 4. Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ù†ÙÛŒÚ¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± (Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² head Ùˆ tail)
        ORIGINAL_CONFIG=$(echo "$ALL_CONFIGS" | head -n "$CONFIG_INDEX" | tail -n 1)

        # 5. ØªØ¹ÛŒÛŒÙ† Ù†Ø§Ù… ÙØ§ÛŒÙ„
        if [ "$CONFIG_INDEX" -eq 1 ]; then
            FILE_PREFIX="$BASE_FILE_NAME"
        else
            FILE_PREFIX="${BASE_FILE_NAME}$((CONFIG_INDEX - 1))"
        fi
        
        FINAL_FILE_NAME="${FILE_PREFIX}${CUSTOM_SUFFIX}.txt"
        OUTPUT_DIR="output"
        
        # 6. Ø§ØµÙ„Ø§Ø­ Ù†Ø§Ù… Ú©Ø§Ù†ÙÛŒÚ¯ Ø¯Ø§Ø®Ù„ÛŒ (Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø³ÙˆÙ†Ø¯ Ø¨Ù‡ Ù†Ø§Ù… Ø¨Ø¹Ø¯ Ø§Ø² #)
        MODIFIED_CONFIG=$(echo "$ORIGINAL_CONFIG" | sed "s/#.*$/#&${CUSTOM_SUFFIX}/" | sed "s/##/#/")

        # 7. Ø³Ø§Ø®Øª Ù¾ÙˆØ´Ù‡ Ø®Ø±ÙˆØ¬ÛŒ Ùˆ Ù†ÙˆØ´ØªÙ† ÙØ§ÛŒÙ„
        mkdir -p "$OUTPUT_DIR"
        echo "$MODIFIED_CONFIG" > "$OUTPUT_DIR/$FINAL_FILE_NAME"

        echo "âœ… Created config: $OUTPUT_DIR/$FINAL_FILE_NAME"
        echo "::set-output name=file_name::${FINAL_FILE_NAME}" # Ø¨Ø±Ø§ÛŒ Commit
        
    # ğŸŒŸ Ú¯Ø§Ù… Ù†Ù‡Ø§ÛŒÛŒ: Commit Ùˆ Push Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡
    - name: Commit and Push Changes
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ¤– Generated sub: ${{ steps.generate_config.outputs.file_name }}"
        file_pattern: output/*.txt
